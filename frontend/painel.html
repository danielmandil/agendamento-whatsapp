<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel - Meus Agendamentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .calendar-day {
            min-height: 120px;
            border: 1px solid #e5e7eb;
        }
        .booking-item {
            font-size: 0.75rem;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 3px;
            cursor: pointer;
        }
        .booking-confirmed {
            background-color: #dcfce7;
            color: #166534;
            border-left: 3px solid #22c55e;
        }
        .booking-cancelled {
            background-color: #fef2f2;
            color: #dc2626;
            border-left: 3px solid #ef4444;
        }
        .blocked-day {
            background-color: #fef2f2;
            color: #dc2626;
            border-left: 3px solid #ef4444;
        }
        .today {
            background-color: #eff6ff;
            border: 2px solid #3b82f6;
        }
        .other-month {
            background-color: #f9fafb;
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto max-w-7xl p-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">
                        üìä Painel de Gest√£o
                    </h1>
                    <p class="text-gray-600" id="barberName">Carregando...</p>
                </div>
                <div class="flex flex-wrap gap-2 mt-4 md:mt-0">
                    <!-- ‚úÖ NOVO BOT√ÉO: Adicionar Agendamento -->
                    <button 
                        onclick="openNewBookingModal()"
                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                    >
                        ‚ûï Novo Agendamento
                    </button>
                    <button 
                    onclick="openConfigModal()"
                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                >
                    ‚öôÔ∏è Configura√ß√µes Completas
                    </button>
                    <button 
                        onclick="toggleView()"
                        id="viewToggle"
                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                    >
                        üìã Ver Lista
                    </button>
                    <div class="bg-gray-100 p-2 rounded">
                        <span class="text-sm text-gray-500">Link para clientes:</span>
                        <div class="text-xs">
                            <code id="bookingLink" class="text-blue-600"></code>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navega√ß√£o do Calend√°rio -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex justify-between items-center">
                <button 
                    onclick="changeMonth(-1)"
                    class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                >
                    ‚Üê Anterior
                </button>
                
                <h2 class="text-xl font-semibold text-gray-800" id="currentMonth">
                    <!-- Ser√° preenchido via JS -->
                </h2>
                
                <button 
                    onclick="changeMonth(1)"
                    class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                >
                    Pr√≥ximo ‚Üí
                </button>
            </div>
        </div>

        <!-- Visualiza√ß√£o em Calend√°rio -->
        <div id="calendarView" class="bg-white rounded-lg shadow-md overflow-hidden">
            <!-- Cabe√ßalho dos dias da semana -->
            <div class="grid grid-cols-7 bg-gray-100">
                <div class="p-3 text-center font-medium text-gray-700">Dom</div>
                <div class="p-3 text-center font-medium text-gray-700">Seg</div>
                <div class="p-3 text-center font-medium text-gray-700">Ter</div>
                <div class="p-3 text-center font-medium text-gray-700">Qua</div>
                <div class="p-3 text-center font-medium text-gray-700">Qui</div>
                <div class="p-3 text-center font-medium text-gray-700">Sex</div>
                <div class="p-3 text-center font-medium text-gray-700">S√°b</div>
            </div>
            
            <!-- Dias do calend√°rio -->
            <div id="calendarGrid" class="grid grid-cols-7">
                <!-- Ser√° preenchido via JavaScript -->
            </div>
        </div>

        <!-- Visualiza√ß√£o em Lista -->
        <div id="listView" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                üìÖ Lista de Agendamentos
            </h2>
            
            <!-- Filtros -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Filtrar por data
                    </label>
                    <input 
                        type="date" 
                        id="dateFilter"
                        class="w-full px-3 py-2 border rounded-lg"
                        onchange="loadBookings()"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Status
                    </label>
                    <select id="statusFilter" class="w-full px-3 py-2 border rounded-lg" onchange="loadBookings()">
                        <option value="">Todos</option>
                        <option value="confirmed">Confirmados</option>
                        <option value="cancelled">Cancelados</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button 
                        onclick="exportBookings()"
                        class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600"
                    >
                        üìä Exportar
                    </button>
                </div>
            </div>
            
            <!-- Lista -->
            <div id="bookingsList" class="space-y-4">
                <!-- Agendamentos ser√£o inseridos aqui via JavaScript -->
            </div>

            <!-- Sem agendamentos -->
            <div id="noBookings" class="hidden text-center py-8">
                <p class="text-gray-500">Nenhum agendamento encontrado.</p>
            </div>
        </div>

        <!-- Estat√≠sticas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <h3 class="text-lg font-semibold text-gray-700">Hoje</h3>
                <p class="text-3xl font-bold text-blue-600" id="todayCount">0</p>
                <p class="text-sm text-gray-500">agendamentos</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <h3 class="text-lg font-semibold text-gray-700">Esta Semana</h3>
                <p class="text-3xl font-bold text-green-600" id="weekCount">0</p>
                <p class="text-sm text-gray-500">agendamentos</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <h3 class="text-lg font-semibold text-gray-700">Este M√™s</h3>
                <p class="text-3xl font-bold text-purple-600" id="monthCount">0</p>
                <p class="text-sm text-gray-500">agendamentos</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <h3 class="text-lg font-semibold text-gray-700">Receita M√™s</h3>
                <p class="text-3xl font-bold text-yellow-600" id="monthRevenue">R$ 0</p>
                <p class="text-sm text-gray-500">estimada</p>
            </div>
        </div>
    </div>

    <!-- ‚úÖ NOVO MODAL: Adicionar Agendamento -->
    <!-- Modal de Novo Agendamento para adicionar ao painel.html -->
<div id="newBookingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">
                    ‚ûï Novo Agendamento Manual
                </h3>
                <button 
                    onclick="closeNewBookingModal()"
                    class="text-gray-500 hover:text-gray-700"
                >
                    ‚úï
                </button>
            </div>

            <form id="newBookingForm" onsubmit="createManualBooking(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Nome do Cliente
                        </label>
                        <input 
                            type="text" 
                            id="manualCustomerName"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                            placeholder="Jo√£o Silva"
                            required
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            WhatsApp
                        </label>
                        <input 
                            type="tel" 
                            id="manualCustomerPhone"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                            placeholder="11999999999"
                            required
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Data
                        </label>
                        <input 
                            type="date" 
                            id="manualDate"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                            onchange="updateAvailableTimeSlots()"
                            required
                        >
                    </div>

                    <!-- SERVI√áO AGORA VEM ANTES DO HOR√ÅRIO -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Servi√ßo
                        </label>
                        <select 
                            id="manualService"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                            onchange="updateAvailableTimeSlots()"
                            required
                        >
                            <option value="">Selecione um servi√ßo</option>
                            <!-- Ser√° preenchido dinamicamente -->
                        </select>
                    </div>

                    <!-- HOR√ÅRIO AGORA VEM DEPOIS DO SERVI√áO -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Hor√°rio Dispon√≠vel
                        </label>
                        <select 
                            id="manualTime"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                            required
                        >
                            <option value="">Selecione data e servi√ßo primeiro</option>
                        </select>
                    </div>

                    <button 
                        type="submit"
                        class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 font-medium"
                    >
                        ‚úÖ Criar Agendamento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript para o Modal de Novo Agendamento -->
<script>
// Vari√°vel global para armazenar o servi√ßo selecionado
let selectedServiceIndex = null;

// Abrir modal de novo agendamento
function openNewBookingModal() {
    document.getElementById('newBookingModal').classList.remove('hidden');
    // Definir data m√≠nima como hoje
    document.getElementById('manualDate').min = new Date().toISOString().split('T')[0];
    // Preencher servi√ßos
    populateServices();
}

// Fechar modal de novo agendamento
function closeNewBookingModal() {
    document.getElementById('newBookingModal').classList.add('hidden');
    document.getElementById('newBookingForm').reset();
    selectedServiceIndex = null;
}

// Preencher dropdown de servi√ßos
function populateServices() {
    const serviceSelect = document.getElementById('manualService');
    serviceSelect.innerHTML = '<option value="">Selecione um servi√ßo</option>';
    
    if (barberData && barberData.services && barberData.services.length > 0) {
        barberData.services.forEach((service, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${service.name} - ${service.duration}min - R$ ${service.price.toFixed(2)}`;
            serviceSelect.appendChild(option);
        });
    } else {
        // Servi√ßo padr√£o se n√£o houver servi√ßos configurados
        const option = document.createElement('option');
        option.value = '0';
        option.textContent = 'Servi√ßo padr√£o - 30min';
        serviceSelect.appendChild(option);
    }
}

// Atualizar hor√°rios dispon√≠veis baseado na data e servi√ßo selecionados
async function updateAvailableTimeSlots() {
    const selectedDate = document.getElementById('manualDate').value;
    const selectedServiceIdx = document.getElementById('manualService').value;
    const timeSelect = document.getElementById('manualTime');
    
    // Limpar hor√°rios
    timeSelect.innerHTML = '<option value="">Selecione data e servi√ßo primeiro</option>';
    
    // Verificar se data e servi√ßo foram selecionados
    if (!selectedDate || selectedServiceIdx === '') {
        return;
    }
    
    // Armazenar √≠ndice do servi√ßo selecionado
    selectedServiceIndex = parseInt(selectedServiceIdx);
    
    // Verificar se √© dia de funcionamento
    const dayOfWeek = new Date(selectedDate + 'T12:00:00').getDay();
    if (barberData.workingDays && !barberData.workingDays.includes(dayOfWeek)) {
        timeSelect.innerHTML = '<option value="">N√£o funciona neste dia</option>';
        return;
    }
    
    try {
        // Buscar agendamentos existentes para a data
        const response = await fetch(`/api/bookings/${barberSlug}/${selectedDate}`);
        const result = await response.json();
        
        if (result.success) {
            const existingBookings = result.data.filter(b => b.status === 'confirmed');
            const barberConfig = result.barberConfig || barberData;
            
            // Obter dura√ß√£o do servi√ßo selecionado
            const selectedService = barberData.services ? barberData.services[selectedServiceIndex] : { duration: 30 };
            const serviceDuration = selectedService.duration;
            const bufferTime = barberConfig.bufferTime || 10;
            
            // Gerar todos os hor√°rios poss√≠veis
            const availableSlots = [];
            const openTime = barberConfig.openTime || barberData.openTime;
            const closeTime = barberConfig.closeTime || barberData.closeTime;
            
            for (let hour = openTime; hour < closeTime; hour++) {
                for (let minute = 0; minute < 60; minute += 15) { // Intervalos de 15 minutos
                    const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    
                    // Verificar se o hor√°rio + dura√ß√£o n√£o ultrapassa o fechamento
                    const slotStart = hour * 60 + minute;
                    const slotEnd = slotStart + serviceDuration + bufferTime;
                    const closingMinutes = closeTime * 60;
                    
                    if (slotEnd > closingMinutes) continue;
                    
                    // Verificar hor√°rio de almo√ßo
                    if (barberConfig.hasLunchBreak) {
                        const lunchStartMinutes = convertTimeToMinutes(barberConfig.lunchStart);
                        const lunchEndMinutes = convertTimeToMinutes(barberConfig.lunchEnd);
                        
                        // Se o hor√°rio come√ßa ou termina durante o almo√ßo, pular
                        if ((slotStart >= lunchStartMinutes && slotStart < lunchEndMinutes) ||
                            (slotEnd > lunchStartMinutes && slotEnd <= lunchEndMinutes) ||
                            (slotStart < lunchStartMinutes && slotEnd > lunchEndMinutes)) {
                            continue;
                        }
                    }
                    
                    // Verificar se conflita com agendamentos existentes
                    let isAvailable = true;
                    for (const booking of existingBookings) {
                        const bookingStart = convertTimeToMinutes(booking.time);
                        const bookingDuration = booking.serviceDuration || 30;
                        const bookingEnd = bookingStart + bookingDuration + bufferTime;
                        
                        // Verificar sobreposi√ß√£o
                        if ((slotStart >= bookingStart && slotStart < bookingEnd) ||
                            (slotEnd > bookingStart && slotEnd <= bookingEnd) ||
                            (slotStart < bookingStart && slotEnd > bookingEnd)) {
                            isAvailable = false;
                            break;
                        }
                    }
                    
                    if (isAvailable) {
                        availableSlots.push(time);
                    }
                }
            }
            
            // Preencher select com hor√°rios dispon√≠veis
            if (availableSlots.length > 0) {
                timeSelect.innerHTML = '';
                availableSlots.forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot;
                    option.textContent = slot;
                    timeSelect.appendChild(option);
                });
            } else {
                timeSelect.innerHTML = '<option value="">Sem hor√°rios dispon√≠veis</option>';
            }
        }
    } catch (error) {
        console.error('Erro ao buscar hor√°rios:', error);
        timeSelect.innerHTML = '<option value="">Erro ao carregar hor√°rios</option>';
    }
}

// Fun√ß√£o auxiliar para converter hor√°rio em minutos
function convertTimeToMinutes(time) {
    const [hours, minutes] = time.split(':').map(Number);
    return hours * 60 + minutes;
}

// Criar agendamento manual
async function createManualBooking(event) {
    event.preventDefault();
    
    const customerName = document.getElementById('manualCustomerName').value.trim();
    const customerPhone = document.getElementById('manualCustomerPhone').value.trim();
    const date = document.getElementById('manualDate').value;
    const time = document.getElementById('manualTime').value;
    const serviceIndex = selectedServiceIndex;
    
    if (!time) {
        alert('Por favor, selecione um hor√°rio dispon√≠vel!');
        return;
    }
    
    const service = barberData.services ? barberData.services[serviceIndex] : {
        name: 'Servi√ßo',
        duration: 30,
        price: 0
    };
    
    try {
        const response = await fetch('/api/bookings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                barberSlug,
                date,
                time,
                customerName,
                customerPhone,
                serviceId: serviceIndex,
                serviceName: service.name,
                serviceDuration: service.duration,
                servicePrice: service.price
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ Agendamento criado com sucesso!');
            closeNewBookingModal();
            
            // Recarregar a p√°gina para atualizar o calend√°rio
            window.location.reload();
        } else {
            alert('‚ùå Erro: ' + result.error);
        }
    } catch (error) {
        console.error('Erro ao criar agendamento:', error);
        alert('‚ùå Erro ao criar agendamento');
    }
}
</script>

 <!-- Este c√≥digo deve ser adicionado ao painel.html -->

<!-- Modal de Configura√ß√£o Completa (substitui o modal de disponibilidade existente) -->
<div id="configModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
        <!-- Header do Modal -->
        <div class="bg-blue-500 text-white p-6">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold">
                    ‚öôÔ∏è Configura√ß√µes Completas
                </h3>
                <button 
                    onclick="closeConfigModal()"
                    class="text-white hover:text-gray-200 text-2xl"
                >
                    ‚úï
                </button>
            </div>
            <p class="text-blue-100 mt-2">Atualize todas as informa√ß√µes do seu neg√≥cio</p>
        </div>

        <!-- Corpo do Modal com scroll -->
        <div class="overflow-y-auto max-h-[calc(90vh-180px)]">
            <form id="updateForm" onsubmit="updateBarberData(event)">
                <!-- Step 1: Informa√ß√µes B√°sicas -->
                <div class="p-6 border-b">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">
                        1Ô∏è‚É£ Informa√ß√µes B√°sicas
                    </h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                Nome da Barbearia *
                            </label>
                            <input 
                                type="text" 
                                id="updateBusinessName"
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                                required
                            >
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                WhatsApp Business *
                            </label>
                            <input 
                                type="tel" 
                                id="updateWhatsapp"
                                placeholder="31999887766"
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                                required
                            >
                        </div>

                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                Email (novo campo)
                            </label>
                            <input 
                                type="email" 
                                id="updateEmail"
                                placeholder="seuemail@exemplo.com"
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                            >
                        </div>

                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                Endere√ßo
                            </label>
                            <input 
                                type="text" 
                                id="updateAddress"
                                placeholder="Rua das Flores, 123 - Centro"
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                            >
                        </div>
                    </div>
                </div>

                <!-- Step 2: Dias de Funcionamento -->
                <div class="p-6 border-b">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">
                        2Ô∏è‚É£ Dias de Funcionamento
                    </h4>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="update-day-1" class="update-day-checkbox" value="1">
                            <span class="font-medium">Segunda</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="update-day-2" class="update-day-checkbox" value="2">
                            <span class="font-medium">Ter√ßa</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="update-day-3" class="update-day-checkbox" value="3">
                            <span class="font-medium">Quarta</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="update-day-4" class="update-day-checkbox" value="4">
                            <span class="font-medium">Quinta</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="update-day-5" class="update-day-checkbox" value="5">
                            <span class="font-medium">Sexta</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="update-day-6" class="update-day-checkbox" value="6">
                            <span class="font-medium">S√°bado</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="update-day-0" class="update-day-checkbox" value="0">
                            <span class="font-medium">Domingo</span>
                        </label>
                    </div>
                    
                    <!-- Configura√ß√£o r√°pida -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm font-medium text-blue-800 mb-2">‚ö° Configura√ß√£o r√°pida:</p>
                        <div class="space-x-2">
                            <button type="button" onclick="setUpdateWorkingDays([1,2,3,4,5,6])" class="text-xs px-3 py-1 bg-blue-500 text-white rounded">Seg-S√°b</button>
                            <button type="button" onclick="setUpdateWorkingDays([1,2,3,4,5])" class="text-xs px-3 py-1 bg-blue-500 text-white rounded">Seg-Sex</button>
                            <button type="button" onclick="setUpdateWorkingDays([2,3,4,5,6])" class="text-xs px-3 py-1 bg-blue-500 text-white rounded">Ter-S√°b</button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Hor√°rios -->
                <div class="p-6 border-b">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">
                        3Ô∏è‚É£ Hor√°rios de Funcionamento
                    </h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                üåÖ Hora de abertura
                            </label>
                            <select id="updateOpenTime" class="w-full px-4 py-2 border rounded-lg">
                                <option value="7">07:00</option>
                                <option value="8">08:00</option>
                                <option value="9">09:00</option>
                                <option value="10">10:00</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                üåÜ Hora de fechamento
                            </label>
                            <select id="updateCloseTime" class="w-full px-4 py-2 border rounded-lg">
                                <option value="17">17:00</option>
                                <option value="18">18:00</option>
                                <option value="19">19:00</option>
                                <option value="20">20:00</option>
                                <option value="21">21:00</option>
                                <option value="22">22:00</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Hor√°rio de Almo√ßo -->
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <label class="flex items-center space-x-2 mb-3">
                            <input type="checkbox" id="updateHasLunchBreak" onchange="toggleUpdateLunchBreak()">
                            <span class="font-medium">üçΩÔ∏è Configurar pausa para almo√ßo</span>
                        </label>
                        
                        <div id="updateLunchBreakConfig" class="hidden grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">In√≠cio da pausa</label>
                                <select id="updateLunchStart" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="11:30">11:30</option>
                                    <option value="12:00" selected>12:00</option>
                                    <option value="12:30">12:30</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Fim da pausa</label>
                                <select id="updateLunchEnd" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="13:00" selected>13:00</option>
                                    <option value="13:30">13:30</option>
                                    <option value="14:00">14:00</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Servi√ßos -->
                <div class="p-6 border-b">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">
                        4Ô∏è‚É£ Servi√ßos e Pre√ßos
                    </h4>
                    
                    <div id="updateServicesList" class="space-y-4 mb-6">
                        <!-- Servi√ßos ser√£o carregados dinamicamente -->
                    </div>
                    
                    <!-- Bot√µes para adicionar servi√ßos comuns -->
                    <div class="mb-4">
                        <p class="text-sm font-medium text-gray-700 mb-2">Adicionar servi√ßos comuns:</p>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" onclick="addUpdateService('Barba', 20, 25)" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">üßî Barba</button>
                            <button type="button" onclick="addUpdateService('Sobrancelha', 15, 15)" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">üëÅÔ∏è Sobrancelha</button>
                            <button type="button" onclick="addUpdateService('Corte + Barba', 45, 55)" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">‚úÇÔ∏èüßî Corte + Barba</button>
                            <button type="button" onclick="addUpdateService('Degrad√™', 40, 40)" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">‚ú® Degrad√™</button>
                        </div>
                    </div>
                    
                    <button 
                        type="button"
                        onclick="addUpdateService()"
                        class="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-blue-400 hover:text-blue-600"
                    >
                        ‚ûï Adicionar outro servi√ßo personalizado
                    </button>
                </div>

                <!-- Step 5: Configura√ß√µes Avan√ßadas -->
                <div class="p-6 border-b">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">
                        5Ô∏è‚É£ Configura√ß√µes de Agendamento
                    </h4>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                ‚è∞ Anteced√™ncia m√≠nima para agendamentos
                            </label>
                            <select id="updateMinAdvanceTime" class="w-full px-4 py-2 border rounded-lg">
                                <option value="0">Podem agendar na hora</option>
                                <option value="1">Pelo menos 1 hora antes</option>
                                <option value="2">Pelo menos 2 horas antes</option>
                                <option value="24">Pelo menos 1 dia antes</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                üî¢ M√°ximo de agendamentos por dia
                            </label>
                            <input 
                                type="number" 
                                id="updateMaxBookingsPerDay"
                                placeholder="0 = sem limite"
                                class="w-full px-4 py-2 border rounded-lg"
                                min="0"
                                value="0"
                            >
                        </div>

                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                ‚è≥ Intervalo entre atendimentos
                            </label>
                            <select id="updateBufferTime" class="w-full px-4 py-2 border rounded-lg">
                                <option value="0">Sem intervalo</option>
                                <option value="5">5 minutos</option>
                                <option value="10">10 minutos</option>
                                <option value="15">15 minutos</option>
                            </select>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Footer do Modal -->
        <div class="bg-gray-50 p-6 border-t">
            <div class="flex justify-end gap-3">
                <button 
                    type="button"
                    onclick="closeConfigModal()"
                    class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                >
                    Cancelar
                </button>
                <button 
                    type="submit"
                    form="updateForm"
                    class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                >
                    üíæ Salvar Todas as Altera√ß√µes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para o Modal -->
<script>
// Abrir modal de configura√ß√µes
function openConfigModal() {
    document.getElementById('configModal').classList.remove('hidden');
    loadCurrentData();
}

// Fechar modal de configura√ß√µes
function closeConfigModal() {
    document.getElementById('configModal').classList.add('hidden');
}

// Carregar dados atuais do barbeiro no modal
function loadCurrentData() {
    if (!barberData) return;
    
    // Informa√ß√µes b√°sicas
    document.getElementById('updateBusinessName').value = barberData.businessName || '';
    document.getElementById('updateWhatsapp').value = barberData.whatsapp || '';
    document.getElementById('updateEmail').value = barberData.email || '';
    document.getElementById('updateAddress').value = barberData.address || '';
    
    // Dias de funcionamento
    document.querySelectorAll('.update-day-checkbox').forEach(cb => cb.checked = false);
    if (barberData.workingDays) {
        barberData.workingDays.forEach(day => {
            const checkbox = document.getElementById(`update-day-${day}`);
            if (checkbox) checkbox.checked = true;
        });
    }
    
    // Hor√°rios
    document.getElementById('updateOpenTime').value = barberData.openTime || 8;
    document.getElementById('updateCloseTime').value = barberData.closeTime || 18;
    document.getElementById('updateBufferTime').value = barberData.bufferTime || 10;
    
    // Hor√°rio de almo√ßo
    if (barberData.hasLunchBreak) {
        document.getElementById('updateHasLunchBreak').checked = true;
        document.getElementById('updateLunchBreakConfig').classList.remove('hidden');
        document.getElementById('updateLunchStart').value = barberData.lunchStart || '12:00';
        document.getElementById('updateLunchEnd').value = barberData.lunchEnd || '13:00';
    }
    
    // Configura√ß√µes avan√ßadas
    document.getElementById('updateMinAdvanceTime').value = barberData.minAdvanceTime || 2;
    document.getElementById('updateMaxBookingsPerDay').value = barberData.maxBookingsPerDay || 0;
    
    // Servi√ßos
    loadUpdateServices();
}

// Carregar servi√ßos no modal
function loadUpdateServices() {
    const servicesList = document.getElementById('updateServicesList');
    servicesList.innerHTML = '';
    
    if (barberData.services && barberData.services.length > 0) {
        barberData.services.forEach((service, index) => {
            const serviceElement = createUpdateServiceElement(service.name, service.duration, service.price, index === 0);
            servicesList.appendChild(serviceElement);
        });
    } else {
        // Servi√ßo padr√£o
        const serviceElement = createUpdateServiceElement('Corte masculino', 30, 35, true);
        servicesList.appendChild(serviceElement);
    }
}

// Criar elemento de servi√ßo para o modal
function createUpdateServiceElement(name = '', duration = 30, price = 0, isFirst = false) {
    const serviceElement = document.createElement('div');
    serviceElement.className = `update-service-item p-4 border-2 rounded-lg ${isFirst ? 'border-blue-200 bg-blue-50' : ''}`;
    
    serviceElement.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‚úÇÔ∏è Servi√ßo</label>
                <input 
                    type="text" 
                    placeholder="Nome do servi√ßo"
                    class="update-service-name w-full px-3 py-2 border rounded"
                    value="${name}"
                    ${isFirst ? 'required' : ''}
                >
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‚è±Ô∏è Tempo</label>
                <select class="update-service-duration w-full px-3 py-2 border rounded">
                    <option value="15" ${duration === 15 ? 'selected' : ''}>15 min</option>
                    <option value="20" ${duration === 20 ? 'selected' : ''}>20 min</option>
                    <option value="30" ${duration === 30 ? 'selected' : ''}>30 min</option>
                    <option value="40" ${duration === 40 ? 'selected' : ''}>40 min</option>
                    <option value="45" ${duration === 45 ? 'selected' : ''}>45 min</option>
                    <option value="60" ${duration === 60 ? 'selected' : ''}>1 hora</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">üí∞ Pre√ßo</label>
                <input 
                    type="number" 
                    placeholder="0.00"
                    class="update-service-price w-full px-3 py-2 border rounded"
                    step="0.01"
                    value="${price}"
                >
            </div>
            <div class="flex items-end">
                <button 
                    type="button"
                    onclick="removeUpdateService(this)"
                    class="text-red-600 hover:text-red-800 text-sm"
                    ${isFirst ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}
                >
                    üóëÔ∏è Remover
                </button>
            </div>
        </div>
    `;
    
    return serviceElement;
}

// Adicionar servi√ßo no modal
function addUpdateService(name = '', duration = 30, price = 0) {
    const servicesList = document.getElementById('updateServicesList');
    const newService = createUpdateServiceElement(name, duration, price, false);
    servicesList.appendChild(newService);
}

// Remover servi√ßo no modal
function removeUpdateService(button) {
    const serviceItem = button.closest('.update-service-item');
    const servicesList = document.getElementById('updateServicesList');
    if (servicesList.children.length > 1) {
        serviceItem.remove();
    } else {
        alert('Voc√™ precisa ter pelo menos um servi√ßo!');
    }
}

// Toggle hor√°rio de almo√ßo
function toggleUpdateLunchBreak() {
    const checkbox = document.getElementById('updateHasLunchBreak');
    const config = document.getElementById('updateLunchBreakConfig');
    config.classList.toggle('hidden', !checkbox.checked);
}

// Configura√ß√£o r√°pida de dias
function setUpdateWorkingDays(days) {
    document.querySelectorAll('.update-day-checkbox').forEach(cb => cb.checked = false);
    days.forEach(day => {
        document.getElementById(`update-day-${day}`).checked = true;
    });
}

// Coletar servi√ßos do formul√°rio
function collectUpdateServices() {
    const services = [];
    document.querySelectorAll('.update-service-item').forEach(item => {
        const name = item.querySelector('.update-service-name').value.trim();
        const duration = parseInt(item.querySelector('.update-service-duration').value);
        const price = parseFloat(item.querySelector('.update-service-price').value) || 0;
        
        if (name) {
            services.push({ name, duration, price });
        }
    });
    return services;
}

// Coletar dias de funcionamento
function collectUpdateWorkingDays() {
    const days = [];
    document.querySelectorAll('.update-day-checkbox:checked').forEach(checkbox => {
        days.push(parseInt(checkbox.value));
    });
    return days;
}

// Atualizar dados do barbeiro
async function updateBarberData(event) {
    event.preventDefault();
    
    const services = collectUpdateServices();
    const workingDays = collectUpdateWorkingDays();
    
    if (services.length === 0) {
        alert('Configure pelo menos um servi√ßo!');
        return;
    }
    
    if (workingDays.length === 0) {
        alert('Selecione pelo menos um dia de funcionamento!');
        return;
    }
    
    const updatedData = {
        businessName: document.getElementById('updateBusinessName').value.trim(),
        whatsapp: document.getElementById('updateWhatsapp').value.trim(),
        email: document.getElementById('updateEmail').value.trim(),
        address: document.getElementById('updateAddress').value.trim(),
        openTime: parseInt(document.getElementById('updateOpenTime').value),
        closeTime: parseInt(document.getElementById('updateCloseTime').value),
        bufferTime: parseInt(document.getElementById('updateBufferTime').value),
        workingDays: workingDays,
        services: services,
        minAdvanceTime: parseInt(document.getElementById('updateMinAdvanceTime').value),
        maxBookingsPerDay: parseInt(document.getElementById('updateMaxBookingsPerDay').value) || 0,
        hasLunchBreak: document.getElementById('updateHasLunchBreak').checked,
        lunchStart: document.getElementById('updateHasLunchBreak').checked ? document.getElementById('updateLunchStart').value : null,
        lunchEnd: document.getElementById('updateHasLunchBreak').checked ? document.getElementById('updateLunchEnd').value : null,
    };
    
    try {
        // Aqui voc√™ faria a chamada para a API para atualizar os dados
        // Por enquanto, vamos simular o sucesso
        console.log('Dados para atualizar:', updatedData);
        
        // TODO: Implementar a chamada real para a API
        // const response = await fetch(`/api/barbers/${barberSlug}`, {
        //     method: 'PUT',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify(updatedData)
        // });
        
        alert('‚úÖ Configura√ß√µes atualizadas com sucesso!');
        closeConfigModal();
        
        // Recarregar a p√°gina para atualizar os dados
        window.location.reload();
        
    } catch (error) {
        console.error('Erro ao atualizar:', error);
        alert('‚ùå Erro ao atualizar configura√ß√µes');
    }
}
</script>

    <!-- ‚úÖ MODAL ATUALIZADO: Detalhes do Agendamento -->
    <div id="bookingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        üìã Detalhes do Agendamento
                    </h3>
                    <button 
                        onclick="closeBookingModal()"
                        class="text-gray-500 hover:text-gray-700"
                    >
                        ‚úï
                    </button>
                </div>

                <div id="bookingDetails" class="space-y-3">
                    <!-- Ser√° preenchido via JS -->
                </div>

                <!-- ‚úÖ BOT√ïES SIMPLIFICADOS -->
                <div class="mt-6 grid grid-cols-2 gap-3">
                    <button 
                        onclick="sendWhatsAppFromModal()"
                        class="bg-green-500 text-white py-2 rounded-lg hover:bg-green-600"
                    >
                        üí¨ WhatsApp
                    </button>
                    <button 
                        onclick="cancelBookingFromModal()"
                        class="bg-red-500 text-white py-2 rounded-lg hover:bg-red-600"
                    >
                        ‚ùå Cancelar Agendamento
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚úÖ MODAL DE CONFIRMA√á√ÉO REMOVIDO (n√£o mais necess√°rio) -->

    <script>
        let barberSlug = '';
        let barberData = null;
        let allBookings = [];
        let currentDate = new Date();
        let currentView = 'calendar';
        let selectedBooking = null;
        let blockedDates = [];
        // ‚úÖ REMOVIDO: bookingToDelete (n√£o mais necess√°rio)

        // Inicializa√ß√£o
        window.addEventListener('DOMContentLoaded', async () => {
            barberSlug = getBarberSlug();
            if (barberSlug) {
                await loadBarberData();
                await loadBookings();
                await loadBlockedDates();
                generateCalendar();
                updateStatistics();
                
                document.getElementById('dateFilter').value = new Date().toISOString().split('T')[0];
                const blockDateElement = document.getElementById('blockDate');
                if (blockDateElement) {
                    blockDateElement.min = new Date().toISOString().split('T')[0];
                }
                document.getElementById('newBookingDate').min = new Date().toISOString().split('T')[0];
            }
        });

        function getBarberSlug() {
            const urlParams = new URLSearchParams(window.location.search);
            const slug = urlParams.get('slug');
            
            if (!slug) {
                const inputSlug = prompt('Digite o c√≥digo do seu neg√≥cio:');
                if (inputSlug) {
                    window.location.href = `?slug=${inputSlug}`;
                } else {
                    alert('C√≥digo necess√°rio para acessar o painel!');
                    window.location.href = '/setup.html';
                }
            }
            
            return slug;
        }

        async function loadBarberData() {
            try {
                const response = await fetch(`/api/barbers/${barberSlug}`);
                const result = await response.json();
                
                if (result.success) {
                    barberData = result.data;
                    document.getElementById('barberName').textContent = barberData.businessName;
                    document.title = `Painel - ${barberData.businessName}`;
                    
                    const bookingUrl = window.location.origin + '/' + barberSlug;
                    document.getElementById('bookingLink').textContent = bookingUrl;

                    document.getElementById('newOpenTime').value = barberData.openTime;
                    document.getElementById('newCloseTime').value = barberData.closeTime;
                    
                    if (barberData.workingDays) {
                        barberData.workingDays.forEach(day => {
                            const checkbox = document.getElementById(`modal-day-${day}`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }

                    // ‚úÖ Preencher servi√ßos no modal de novo agendamento
                    populateServicesDropdown();
                } else {
                    alert('Barbeiro n√£o encontrado!');
                    window.location.href = '/setup.html';
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        // ‚úÖ NOVA FUN√á√ÉO: Preencher dropdown de servi√ßos
        function populateServicesDropdown() {
            const serviceSelect = document.getElementById('newBookingService');
            serviceSelect.innerHTML = '<option value="">Selecione um servi√ßo</option>';
            
            if (barberData.services && barberData.services.length > 0) {
                barberData.services.forEach((service, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${service.name} - ${service.duration}min - R$ ${service.price.toFixed(2)}`;
                    serviceSelect.appendChild(option);
                });
            } else {
                // Servi√ßo padr√£o se n√£o tiver m√∫ltiplos
                const option = document.createElement('option');
                option.value = '0';
                option.textContent = `Servi√ßo - ${barberData.serviceDuration || 30}min`;
                serviceSelect.appendChild(option);
            }
        }

        async function loadBookings() {
            console.log('üì• Iniciando loadBookings...');
            try {
                const dateFilter = document.getElementById('dateFilter')?.value;
                const statusFilter = document.getElementById('statusFilter')?.value;
                
                let url = `/api/barbers/${barberSlug}/bookings`;
                const params = new URLSearchParams();
                
                if (dateFilter) params.append('date', dateFilter);
                if (statusFilter) params.append('status', statusFilter);
                
                if (params.toString()) url += '?' + params.toString();
                
                console.log('üîó Fazendo requisi√ß√£o para:', url);
                
                const response = await fetch(url);
                const result = await response.json();
                
                console.log('üìä Resposta da API:', result);
                
                if (result.success) {
                    console.log('‚úÖ Dados recebidos:', result.data.length, 'agendamentos');
                    allBookings = result.data;
                    
                    console.log('üóìÔ∏è Chamando generateCalendar...');
                    generateCalendar(); // Sempre gerar calend√°rio
                    
                    if (currentView === 'list') {
                        console.log('üìã Atualizando lista...');
                        displayBookingsList(allBookings);
                    }
                    
                    console.log('üìà Atualizando estat√≠sticas...');
                    updateStatistics();
                    
                    console.log(`‚úÖ ${allBookings.length} agendamentos carregados e interface atualizada`);
                } else {
                    console.error('‚ùå Erro na resposta da API:', result.error);
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar agendamentos:', error);
            }
        }

        async function loadBlockedDates() {
            try {
                const response = await fetch(`/api/barbers/${barberSlug}/blocked-dates`);
                const result = await response.json();
                
                if (result.success) {
                    blockedDates = result.data || [];
                    updateBlockedDatesList();
                } else {
                    console.log('Nenhuma data bloqueada encontrada');
                    blockedDates = [];
                }
            } catch (error) {
                console.error('Erro ao carregar datas bloqueadas:', error);
                blockedDates = [];
            }
        }

        function updateBlockedDatesList() {
            const blockedDatesList = document.getElementById('blockedDatesList');
            
            if (blockedDates.length === 0) {
                blockedDatesList.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">Nenhuma data bloqueada</p>';
                return;
            }
            
            blockedDatesList.innerHTML = '';
            
            blockedDates.forEach(dateString => {
                const dateItem = document.createElement('div');
                dateItem.className = 'flex justify-between items-center p-2 bg-red-50 border border-red-200 rounded mb-2';
                
                const formattedDate = new Date(dateString + 'T12:00:00').toLocaleDateString('pt-BR');
                
                dateItem.innerHTML = `
                    <span class="text-sm text-red-700">üìÖ ${formattedDate}</span>
                    <button 
                        onclick="unblockDate('${dateString}')"
                        class="text-xs px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600"
                    >
                        Desbloquear
                    </button>
                `;
                
                blockedDatesList.appendChild(dateItem);
            });
        }

        async function toggleDateAvailability() {
            const dateInput = document.getElementById('blockDate');
            const selectedDate = dateInput.value;
            
            if (!selectedDate) {
                alert('Selecione uma data para bloquear');
                return;
            }
            
            const button = document.getElementById('blockDateBtn');
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Processando...';
            
            try {
                const isBlocked = blockedDates.includes(selectedDate);
                
                if (isBlocked) {
                    await unblockDate(selectedDate);
                } else {
                    await blockDate(selectedDate);
                }
                
                dateInput.value = '';
                
            } catch (error) {
                console.error('Erro ao alterar disponibilidade:', error);
                alert('Erro ao alterar disponibilidade da data');
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        async function blockDate(dateString) {
            try {
                const response = await fetch('/api/blocked-dates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        barberSlug,
                        date: dateString,
                        action: 'block'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    blockedDates.push(dateString);
                    updateBlockedDatesList();
                    generateCalendar();
                    
                    const formattedDate = new Date(dateString + 'T12:00:00').toLocaleDateString('pt-BR');
                    alert(`‚úÖ Data ${formattedDate} foi bloqueada com sucesso!`);
                } else {
                    throw new Error(result.error || 'Erro ao bloquear data');
                }
            } catch (error) {
                console.error('Erro ao bloquear data:', error);
                throw error;
            }
        }

        async function unblockDate(dateString) {
            try {
                const response = await fetch('/api/blocked-dates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        barberSlug,
                        date: dateString,
                        action: 'unblock'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    blockedDates = blockedDates.filter(date => date !== dateString);
                    updateBlockedDatesList();
                    generateCalendar();
                    
                    const formattedDate = new Date(dateString + 'T12:00:00').toLocaleDateString('pt-BR');
                    alert(`‚úÖ Data ${formattedDate} foi desbloqueada com sucesso!`);
                } else {
                    throw new Error(result.error || 'Erro ao desbloquear data');
                }
            } catch (error) {
                console.error('Erro ao desbloquear data:', error);
                throw error;
            }
        }

        // ‚úÖ NOVA FUN√á√ÉO: Abrir modal de adicionar agendamento
        function openAddBookingModal() {
            document.getElementById('addBookingModal').classList.remove('hidden');
            
            // Configurar data m√≠nima como hoje
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newBookingDate').value = today;
            
            // Carregar hor√°rios para hoje
            loadAvailableTimesForDate(today);
            
            // Event listener para mudan√ßa de data
            document.getElementById('newBookingDate').addEventListener('change', function() {
                loadAvailableTimesForDate(this.value);
            });
        }

        // ‚úÖ NOVA FUN√á√ÉO: Fechar modal de adicionar agendamento
        function closeAddBookingModal() {
            document.getElementById('addBookingModal').classList.add('hidden');
            document.getElementById('addBookingForm').reset();
        }

        // ‚úÖ NOVA FUN√á√ÉO: Carregar hor√°rios dispon√≠veis para uma data
        async function loadAvailableTimesForDate(dateString) {
            const timeSelect = document.getElementById('newBookingTime');
            timeSelect.innerHTML = '<option value="">Carregando...</option>';
            
            try {
                const response = await fetch(`/api/bookings/${barberSlug}/${dateString}`);
                const result = await response.json();
                
                if (result.success) {
                    const existingBookings = result.data;
                    const config = result.barberConfig;
                    
                    timeSelect.innerHTML = '<option value="">Selecione um hor√°rio</option>';
                    
                    // Gerar hor√°rios dispon√≠veis
                    const serviceDuration = 30; // Padr√£o, ser√° ajustado quando servi√ßo for selecionado
                    const bufferTime = config.bufferTime || 0;
                    
                    for (let hour = config.openTime; hour < config.closeTime; hour++) {
                        for (let minute = 0; minute < 60; minute += serviceDuration + bufferTime) {
                            const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                            
                            // Verificar se hor√°rio est√° ocupado
                            const isBooked = existingBookings.some(booking => booking.time === timeString);
                            
                            if (!isBooked) {
                                const option = document.createElement('option');
                                option.value = timeString;
                                option.textContent = timeString;
                                timeSelect.appendChild(option);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar hor√°rios:', error);
                timeSelect.innerHTML = '<option value="">Erro ao carregar hor√°rios</option>';
            }
        }

        // ‚úÖ NOVA FUN√á√ÉO: Salvar novo agendamento
        document.getElementById('addBookingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const saveBtn = document.getElementById('saveBookingBtn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'Salvando...';
            
            try {
                const formData = {
                    barberSlug,
                    customerName: document.getElementById('newCustomerName').value.trim(),
                    customerPhone: document.getElementById('newCustomerPhone').value.trim(),
                    date: document.getElementById('newBookingDate').value,
                    time: document.getElementById('newBookingTime').value
                };
                
                // Adicionar dados do servi√ßo se selecionado
                const serviceIndex = document.getElementById('newBookingService').value;
                if (serviceIndex !== '' && barberData.services && barberData.services[serviceIndex]) {
                    const service = barberData.services[serviceIndex];
                    formData.serviceId = serviceIndex;
                    formData.serviceName = service.name;
                    formData.serviceDuration = service.duration;
                    formData.servicePrice = service.price;
                }
                
                const response = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Agendamento criado com sucesso!');
                    window.location.reload();
                    closeAddBookingModal();
                    
                    // ‚úÖ SIMPLIFICADO: loadBookings() j√° cuida de tudo
                    await loadBookings();
                } else {
                    throw new Error(result.error || 'Erro ao criar agendamento');
                }
                
            } catch (error) {
                console.error('Erro ao salvar agendamento:', error);
                alert('‚ùå Erro ao criar agendamento: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        });

        function generateCalendar() {
            console.log('üóìÔ∏è Gerando calend√°rio...');
            console.log('   barberData:', barberData);
            console.log('   allBookings length:', allBookings.length);
            console.log('   currentDate:', currentDate);
            
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonth = document.getElementById('currentMonth');
            
            if (!calendarGrid) {
                console.error('‚ùå calendarGrid n√£o encontrado!');
                return;
            }
            
            if (!barberData) {
                console.error('‚ùå barberData n√£o dispon√≠vel!');
                return;
            }
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            currentMonth.textContent = `${monthNames[month]} ${year}`;
            
            // Limpar calend√°rio
            calendarGrid.innerHTML = '';
            console.log('üìÖ Calend√°rio limpo, come√ßando a gerar dias...');
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            let daysGenerated = 0;
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day p-2';
                
                const isToday = date.toDateString() === new Date().toDateString();
                const isCurrentMonth = date.getMonth() === month;
                const dayOfWeek = date.getDay();
                const isWorkingDay = barberData?.workingDays?.includes(dayOfWeek);
                const dateStr = date.toISOString().split('T')[0];
                const isBlocked = blockedDates.includes(dateStr);
                
                if (isToday) dayElement.classList.add('today');
                if (!isCurrentMonth) dayElement.classList.add('other-month');
                if (!isWorkingDay) dayElement.style.backgroundColor = '#f3f4f6';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'font-medium text-sm mb-1';
                dayNumber.textContent = date.getDate();
                dayElement.appendChild(dayNumber);
                
                if (isBlocked) {
                    const blockedEl = document.createElement('div');
                    blockedEl.className = 'blocked-day';
                    blockedEl.textContent = 'üö´ Bloqueado';
                    dayElement.appendChild(blockedEl);
                }
                
                const dayBookings = allBookings.filter(booking => booking.date === dateStr);
                
                dayBookings.forEach(booking => {
                    const bookingEl = document.createElement('div');
                    bookingEl.className = `booking-item ${booking.status === 'confirmed' ? 'booking-confirmed' : 'booking-cancelled'}`;
                    bookingEl.textContent = `${booking.time} - ${booking.customerName}`;
                    bookingEl.onclick = () => showBookingDetails(booking);
                    dayElement.appendChild(bookingEl);
                });
                
                calendarGrid.appendChild(dayElement);
                daysGenerated++;
            }
            
            console.log(`‚úÖ Calend√°rio gerado com ${daysGenerated} dias`);
            console.log('üìä Agendamentos no calend√°rio:', allBookings.length);
        }

        function displayBookingsList(bookings) {
            const bookingsList = document.getElementById('bookingsList');
            const noBookings = document.getElementById('noBookings');
            
            bookingsList.innerHTML = '';
            
            if (bookings.length === 0) {
                noBookings.classList.remove('hidden');
                return;
            }
            
            noBookings.classList.add('hidden');
            
            bookings.forEach(booking => {
                const bookingCard = document.createElement('div');
                bookingCard.className = 'border rounded-lg p-4 hover:bg-gray-50 cursor-pointer';
                bookingCard.onclick = () => showBookingDetails(booking);
                
                const statusColor = booking.status === 'confirmed' ? 'green' : 'red';
                const statusText = booking.status === 'confirmed' ? 'Confirmado' : 'Cancelado';
                
                bookingCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-gray-800">${booking.customerName}</h3>
                            <p class="text-sm text-gray-600">üì± ${booking.customerPhone}</p>
                            <p class="text-sm text-gray-600">üìÖ ${formatDate(booking.date)} √†s ${booking.time}</p>
                            ${booking.serviceName ? `<p class="text-sm text-gray-600">‚úÇÔ∏è ${booking.serviceName} (${booking.serviceDuration}min)</p>` : ''}
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-3 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                ${statusText}
                            </span>
                            ${booking.servicePrice ? `<p class="text-sm font-medium text-green-600 mt-1">R$ ${booking.servicePrice.toFixed(2)}</p>` : ''}
                        </div>
                    </div>
                `;
                
                bookingsList.appendChild(bookingCard);
            });
        }

        function updateStatistics() {
            const today = new Date().toISOString().split('T')[0];
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            const startOfMonth = new Date();
            startOfMonth.setDate(1);
            
            const todayBookings = allBookings.filter(b => b.date === today && b.status === 'confirmed');
            const weekBookings = allBookings.filter(b => {
                const bookingDate = new Date(b.date);
                return bookingDate >= startOfWeek && b.status === 'confirmed';
            });
            const monthBookings = allBookings.filter(b => {
                const bookingDate = new Date(b.date);
                return bookingDate >= startOfMonth && b.status === 'confirmed';
            });
            
            const monthRevenue = monthBookings.reduce((sum, booking) => sum + (booking.servicePrice || 0), 0);
            
            document.getElementById('todayCount').textContent = todayBookings.length;
            document.getElementById('weekCount').textContent = weekBookings.length;
            document.getElementById('monthCount').textContent = monthBookings.length;
            document.getElementById('monthRevenue').textContent = `R$ ${monthRevenue.toFixed(2)}`;
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar();
        }

        function toggleView() {
            const calendarView = document.getElementById('calendarView');
            const listView = document.getElementById('listView');
            const toggleBtn = document.getElementById('viewToggle');
            
            if (currentView === 'calendar') {
                currentView = 'list';
                calendarView.classList.add('hidden');
                listView.classList.remove('hidden');
                toggleBtn.textContent = 'üìÖ Ver Calend√°rio';
                displayBookingsList(allBookings);
            } else {
                currentView = 'calendar';
                calendarView.classList.remove('hidden');
                listView.classList.add('hidden');
                toggleBtn.textContent = 'üìã Ver Lista';
                generateCalendar();
            }
        }

        function openAvailabilityModal() {
            document.getElementById('availabilityModal').classList.remove('hidden');
            updateBlockedDatesList();
        }

        function closeAvailabilityModal() {
            document.getElementById('availabilityModal').classList.add('hidden');
        }

        function showBookingDetails(booking) {
            selectedBooking = booking;
            const modal = document.getElementById('bookingModal');
            const details = document.getElementById('bookingDetails');
            
            const statusColor = booking.status === 'confirmed' ? 'text-green-600' : 'text-red-600';
            const statusText = booking.status === 'confirmed' ? 'Confirmado' : 'Cancelado';
            
            details.innerHTML = `
                <div class="border-b pb-3 mb-3">
                    <h4 class="font-medium text-gray-800">${booking.customerName}</h4>
                    <p class="text-sm text-gray-600">üì± ${booking.customerPhone}</p>
                </div>
                <div class="space-y-2 text-sm">
                    <p><strong>Data:</strong> ${formatDate(booking.date)}</p>
                    <p><strong>Hor√°rio:</strong> ${booking.time}</p>
                    ${booking.serviceName ? `<p><strong>Servi√ßo:</strong> ${booking.serviceName}</p>` : ''}
                    ${booking.serviceDuration ? `<p><strong>Dura√ß√£o:</strong> ${booking.serviceDuration} minutos</p>` : ''}
                    ${booking.servicePrice ? `<p><strong>Pre√ßo:</strong> R$ ${booking.servicePrice.toFixed(2)}</p>` : ''}
                    <p><strong>Status:</strong> <span class="${statusColor}">${statusText}</span></p>
                    <p><strong>Criado em:</strong> ${new Date(booking.createdAt).toLocaleString('pt-BR')}</p>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.add('hidden');
            selectedBooking = null;
        }

        // ‚úÖ FUN√á√ÉO REMOVIDA: deleteBookingFromModal (n√£o mais necess√°ria)
        
        // ‚úÖ FUN√á√ÉO REMOVIDA: closeConfirmModal (n√£o mais necess√°ria)
        
        // ‚úÖ FUN√á√ÉO REMOVIDA: confirmDelete (n√£o mais necess√°ria)

        function formatDate(dateString) {
            const date = new Date(dateString + 'T12:00:00');
            return date.toLocaleDateString('pt-BR');
        }

        function sendWhatsAppFromModal() {
            if (!selectedBooking) return;
            
            const message = `Ol√° ${selectedBooking.customerName}! Confirmando seu agendamento para ${formatDate(selectedBooking.date)} √†s ${selectedBooking.time}. At√© l√°! üòä`;
            const whatsappUrl = `https://wa.me/${selectedBooking.customerPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function exportBookings() {
            alert('Funcionalidade de exporta√ß√£o em desenvolvimento!');
        }

        function updateSchedule() {
            alert('Funcionalidade em desenvolvimento!');
        }

        function updateWorkingDays() {
            alert('Funcionalidade em desenvolvimento!');
        }

        // ‚úÖ FUN√á√ÉO IMPLEMENTADA: Cancelar agendamento
        async function cancelBookingFromModal() {
            if (!selectedBooking) return;
            
            if (selectedBooking.status === 'cancelled') {
                alert('Este agendamento j√° est√° cancelado!');
                return;
            }
            
            if (!confirm(`Tem certeza que deseja cancelar o agendamento de ${selectedBooking.customerName}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/bookings/${selectedBooking.bookingId}/cancel`, {
                    method: 'PATCH'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Agendamento cancelado com sucesso!');
                    window.location.reload();
                    closeBookingModal();
                    
                    // ‚úÖ SIMPLIFICADO: loadBookings() j√° cuida de tudo
                    await loadBookings();
                } else {
                    throw new Error(result.error || 'Erro ao cancelar agendamento');
                }
                
            } catch (error) {
                console.error('Erro ao cancelar agendamento:', error);
                alert('‚ùå Erro ao cancelar agendamento: ' + error.message);
            }
        }
    </script>
</body>
</html>