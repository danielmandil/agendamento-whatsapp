<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel - Meus Agendamentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .calendar-day {
            min-height: 120px;
            border: 1px solid #e5e7eb;
        }
        .booking-item {
            font-size: 0.75rem;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 3px;
            cursor: pointer;
        }
        .booking-confirmed {
            background-color: #dcfce7;
            color: #166534;
            border-left: 3px solid #22c55e;
        }
        .booking-cancelled {
            background-color: #fef2f2;
            color: #dc2626;
            border-left: 3px solid #ef4444;
        }
        .today {
            background-color: #eff6ff;
            border: 2px solid #3b82f6;
        }
        .other-month {
            background-color: #f9fafb;
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto max-w-7xl p-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">
                        üìä Painel de Gest√£o
                    </h1>
                    <p class="text-gray-600" id="barberName">Carregando...</p>
                </div>
                <div class="flex flex-wrap gap-2 mt-4 md:mt-0">
                    <button 
                        onclick="openAvailabilityModal()"
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                    >
                        ‚öôÔ∏è Configurar Disponibilidade
                    </button>
                    <button 
                        onclick="toggleView()"
                        id="viewToggle"
                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                    >
                        üìã Ver Lista
                    </button>
                    <div class="bg-gray-100 p-2 rounded">
                        <span class="text-sm text-gray-500">Link para clientes:</span>
                        <div class="text-xs">
                            <code id="bookingLink" class="text-blue-600"></code>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navega√ß√£o do Calend√°rio -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex justify-between items-center">
                <button 
                    onclick="changeMonth(-1)"
                    class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                >
                    ‚Üê Anterior
                </button>
                
                <h2 class="text-xl font-semibold text-gray-800" id="currentMonth">
                    <!-- Ser√° preenchido via JS -->
                </h2>
                
                <button 
                    onclick="changeMonth(1)"
                    class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                >
                    Pr√≥ximo ‚Üí
                </button>
            </div>
        </div>

        <!-- Visualiza√ß√£o em Calend√°rio -->
        <div id="calendarView" class="bg-white rounded-lg shadow-md overflow-hidden">
            <!-- Cabe√ßalho dos dias da semana -->
            <div class="grid grid-cols-7 bg-gray-100">
                <div class="p-3 text-center font-medium text-gray-700">Dom</div>
                <div class="p-3 text-center font-medium text-gray-700">Seg</div>
                <div class="p-3 text-center font-medium text-gray-700">Ter</div>
                <div class="p-3 text-center font-medium text-gray-700">Qua</div>
                <div class="p-3 text-center font-medium text-gray-700">Qui</div>
                <div class="p-3 text-center font-medium text-gray-700">Sex</div>
                <div class="p-3 text-center font-medium text-gray-700">S√°b</div>
            </div>
            
            <!-- Dias do calend√°rio -->
            <div id="calendarGrid" class="grid grid-cols-7">
                <!-- Ser√° preenchido via JavaScript -->
            </div>
        </div>

        <!-- Visualiza√ß√£o em Lista -->
        <div id="listView" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                üìÖ Lista de Agendamentos
            </h2>
            
            <!-- Filtros -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Filtrar por data
                    </label>
                    <input 
                        type="date" 
                        id="dateFilter"
                        class="w-full px-3 py-2 border rounded-lg"
                        onchange="loadBookings()"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Status
                    </label>
                    <select id="statusFilter" class="w-full px-3 py-2 border rounded-lg" onchange="loadBookings()">
                        <option value="">Todos</option>
                        <option value="confirmed">Confirmados</option>
                        <option value="cancelled">Cancelados</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button 
                        onclick="exportBookings()"
                        class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600"
                    >
                        üìä Exportar
                    </button>
                </div>
            </div>
            
            <!-- Lista -->
            <div id="bookingsList" class="space-y-4">
                <!-- Agendamentos ser√£o inseridos aqui via JavaScript -->
            </div>

            <!-- Sem agendamentos -->
            <div id="noBookings" class="hidden text-center py-8">
                <p class="text-gray-500">Nenhum agendamento encontrado.</p>
            </div>
        </div>

        <!-- Estat√≠sticas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <h3 class="text-lg font-semibold text-gray-700">Hoje</h3>
                <p class="text-3xl font-bold text-blue-600" id="todayCount">0</p>
                <p class="text-sm text-gray-500">agendamentos</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <h3 class="text-lg font-semibold text-gray-700">Esta Semana</h3>
                <p class="text-3xl font-bold text-green-600" id="weekCount">0</p>
                <p class="text-sm text-gray-500">agendamentos</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <h3 class="text-lg font-semibold text-gray-700">Este M√™s</h3>
                <p class="text-3xl font-bold text-purple-600" id="monthCount">0</p>
                <p class="text-sm text-gray-500">agendamentos</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <h3 class="text-lg font-semibold text-gray-700">Receita M√™s</h3>
                <p class="text-3xl font-bold text-yellow-600" id="monthRevenue">R$ 0</p>
                <p class="text-sm text-gray-500">estimada</p>
            </div>
        </div>
    </div>

    <!-- Modal de Configura√ß√£o de Disponibilidade -->
    <div id="availabilityModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-90vh overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        ‚öôÔ∏è Configurar Disponibilidade
                    </h3>
                    <button 
                        onclick="closeAvailabilityModal()"
                        class="text-gray-500 hover:text-gray-700"
                    >
                        ‚úï
                    </button>
                </div>

                <!-- Bloquear/Desbloquear Dias -->
                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-3">üìÖ Bloquear Dias Espec√≠ficos</h4>
                    <div class="flex gap-2">
                        <input 
                            type="date" 
                            id="blockDate"
                            class="flex-1 px-3 py-2 border rounded-lg"
                        >
                        <button 
                            onclick="toggleDateAvailability()"
                            id="blockDateBtn"
                            class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600"
                        >
                            üö´ Bloquear
                        </button>
                    </div>
                    
                    <!-- Lista de dias bloqueados -->
                    <div id="blockedDatesList" class="mt-3 max-h-40 overflow-y-auto">
                        <!-- Ser√° preenchido via JS -->
                    </div>
                </div>

                <!-- Configura√ß√£o de Hor√°rios -->
                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-3">üïê Alterar Hor√°rios</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Abertura</label>
                            <select id="newOpenTime" class="w-full px-3 py-2 border rounded-lg">
                                <option value="7">07:00</option>
                                <option value="8">08:00</option>
                                <option value="9">09:00</option>
                                <option value="10">10:00</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Fechamento</label>
                            <select id="newCloseTime" class="w-full px-3 py-2 border rounded-lg">
                                <option value="17">17:00</option>
                                <option value="18">18:00</option>
                                <option value="19">19:00</option>
                                <option value="20">20:00</option>
                                <option value="21">21:00</option>
                            </select>
                        </div>
                    </div>
                    <button 
                        onclick="updateSchedule()"
                        class="mt-3 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"
                    >
                        üíæ Salvar Hor√°rios
                    </button>
                </div>

                <!-- Dias da Semana -->
                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-3">üìÜ Dias de Funcionamento</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="modal-day-1" class="modal-day-checkbox" value="1">
                            <span>Segunda</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="modal-day-2" class="modal-day-checkbox" value="2">
                            <span>Ter√ßa</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="modal-day-3" class="modal-day-checkbox" value="3">
                            <span>Quarta</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="modal-day-4" class="modal-day-checkbox" value="4">
                            <span>Quinta</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="modal-day-5" class="modal-day-checkbox" value="5">
                            <span>Sexta</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="modal-day-6" class="modal-day-checkbox" value="6">
                            <span>S√°bado</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="modal-day-0" class="modal-day-checkbox" value="0">
                            <span>Domingo</span>
                        </label>
                    </div>
                    <button 
                        onclick="updateWorkingDays()"
                        class="mt-3 w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600"
                    >
                        üíæ Salvar Dias
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Agendamento -->
    <div id="bookingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        üìã Detalhes do Agendamento
                    </h3>
                    <button 
                        onclick="closeBookingModal()"
                        class="text-gray-500 hover:text-gray-700"
                    >
                        ‚úï
                    </button>
                </div>

                <div id="bookingDetails" class="space-y-3">
                    <!-- Ser√° preenchido via JS -->
                </div>

                <div class="mt-6 flex gap-3">
                    <button 
                        onclick="sendWhatsAppFromModal()"
                        class="flex-1 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600"
                    >
                        üí¨ WhatsApp
                    </button>
                    <button 
                        onclick="cancelBookingFromModal()"
                        class="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600"
                    >
                        ‚ùå Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let barberSlug = '';
        let barberData = null;
        let allBookings = [];
        let currentDate = new Date();
        let currentView = 'calendar';
        let selectedBooking = null;
        let availabilityRules = [];
        let currentDateRule = null;

        // ===== INICIALIZA√á√ÉO =====
        window.addEventListener('DOMContentLoaded', async () => {
            barberSlug = getBarberSlug();
            if (barberSlug) {
                await loadBarberData();
                await loadBookings();
                generateCalendar();
                updateStatistics();
                
                // Define data de hoje no filtro
                document.getElementById('dateFilter').value = new Date().toISOString().split('T')[0];
                
                // Configurar data m√≠nima (hoje)
                const today = new Date().toISOString().split('T')[0];
                const selectedDateInput = document.getElementById('selectedDate');
                if (selectedDateInput) {
                    selectedDateInput.min = today;
                }
            }
        });

        // ===== GEST√ÉO DE BARBEIRO =====
        function getBarberSlug() {
            const urlParams = new URLSearchParams(window.location.search);
            const slug = urlParams.get('slug');
            
            if (!slug) {
                const inputSlug = prompt('Digite o c√≥digo do seu neg√≥cio:');
                if (inputSlug) {
                    window.location.href = `?slug=${inputSlug}`;
                } else {
                    alert('C√≥digo necess√°rio para acessar o painel!');
                    window.location.href = '/setup.html';
                }
            }
            
            return slug;
        }

        async function loadBarberData() {
            try {
                const response = await fetch(`/api/barbers/${barberSlug}`);
                const result = await response.json();
                
                if (result.success) {
                    barberData = result.data;
                    document.getElementById('barberName').textContent = barberData.businessName;
                    document.title = `Painel - ${barberData.businessName}`;
                    
                    const bookingUrl = window.location.origin + '/' + barberSlug;
                    document.getElementById('bookingLink').textContent = bookingUrl;

                    // Preencher modal com dados atuais
                    document.getElementById('newOpenTime').value = barberData.openTime;
                    document.getElementById('newCloseTime').value = barberData.closeTime;
                    
                    if (barberData.workingDays) {
                        // Limpar sele√ß√µes anteriores
                        document.querySelectorAll('.modal-day-checkbox').forEach(cb => cb.checked = false);
                        
                        // Marcar dias atuais
                        barberData.workingDays.forEach(day => {
                            const checkbox = document.getElementById(`modal-day-${day}`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }

                    // Carregar regras de disponibilidade
                    await loadAvailabilityRules();
                } else {
                    alert('Barbeiro n√£o encontrado!');
                    window.location.href = '/setup.html';
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        // Carrega agendamentos
        async function loadBookings() {
            try {
                const dateFilter = document.getElementById('dateFilter')?.value;
                const statusFilter = document.getElementById('statusFilter')?.value;
                
                let url = `/api/barbers/${barberSlug}/bookings`;
                const params = new URLSearchParams();
                
                if (dateFilter) params.append('date', dateFilter);
                if (statusFilter) params.append('status', statusFilter);
                
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    allBookings = result.data;
                    if (currentView === 'list') {
                        displayBookingsList(allBookings);
                    } else {
                        generateCalendar();
                    }
                    updateStatistics();
                }
            } catch (error) {
                console.error('Erro ao carregar agendamentos:', error);
            }
        }

        // Gera o calend√°rio
        function generateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonth = document.getElementById('currentMonth');
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Atualizar t√≠tulo do m√™s
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            currentMonth.textContent = `${monthNames[month]} ${year}`;
            
            // Limpar calend√°rio
            calendarGrid.innerHTML = '';
            
            // Primeiro dia do m√™s e √∫ltimo dia
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // Gerar 42 dias (6 semanas)
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day p-2';
                
                // Classes condicionais
                const isToday = date.toDateString() === new Date().toDateString();
                const isCurrentMonth = date.getMonth() === month;
                const dayOfWeek = date.getDay();
                const isWorkingDay = barberData?.workingDays?.includes(dayOfWeek);
                
                if (isToday) dayElement.classList.add('today');
                if (!isCurrentMonth) dayElement.classList.add('other-month');
                if (!isWorkingDay) dayElement.style.backgroundColor = '#f3f4f6';
                
                // N√∫mero do dia
                const dayNumber = document.createElement('div');
                dayNumber.className = 'font-medium text-sm mb-1';
                dayNumber.textContent = date.getDate();
                dayElement.appendChild(dayNumber);
                
                // Agendamentos do dia
                const dateStr = date.toISOString().split('T')[0];
                const dayBookings = allBookings.filter(booking => booking.date === dateStr);
                
                dayBookings.forEach(booking => {
                    const bookingEl = document.createElement('div');
                    bookingEl.className = `booking-item ${booking.status === 'confirmed' ? 'booking-confirmed' : 'booking-cancelled'}`;
                    bookingEl.textContent = `${booking.time} - ${booking.customerName}`;
                    bookingEl.onclick = () => showBookingDetails(booking);
                    dayElement.appendChild(bookingEl);
                });
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // Exibe lista de agendamentos
        function displayBookingsList(bookings) {
            const bookingsList = document.getElementById('bookingsList');
            const noBookings = document.getElementById('noBookings');
            
            bookingsList.innerHTML = '';
            
            if (bookings.length === 0) {
                noBookings.classList.remove('hidden');
                return;
            }
            
            noBookings.classList.add('hidden');
            
            bookings.forEach(booking => {
                const bookingCard = document.createElement('div');
                bookingCard.className = 'border rounded-lg p-4 hover:bg-gray-50 cursor-pointer';
                bookingCard.onclick = () => showBookingDetails(booking);
                
                const statusColor = booking.status === 'confirmed' ? 'green' : 'red';
                const statusText = booking.status === 'confirmed' ? 'Confirmado' : 'Cancelado';
                
                bookingCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-gray-800">${booking.customerName}</h3>
                            <p class="text-sm text-gray-600">üì± ${booking.customerPhone}</p>
                            <p class="text-sm text-gray-600">üìÖ ${formatDate(booking.date)} √†s ${booking.time}</p>
                            ${booking.serviceName ? `<p class="text-sm text-gray-600">‚úÇÔ∏è ${booking.serviceName} (${booking.serviceDuration}min)</p>` : ''}
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-3 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                ${statusText}
                            </span>
                            ${booking.servicePrice ? `<p class="text-sm font-medium text-green-600 mt-1">R$ ${booking.servicePrice.toFixed(2)}</p>` : ''}
                        </div>
                    </div>
                `;
                
                bookingsList.appendChild(bookingCard);
            });
        }

        // Atualiza estat√≠sticas
        function updateStatistics() {
            const today = new Date().toISOString().split('T')[0];
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            const startOfMonth = new Date();
            startOfMonth.setDate(1);
            
            const todayBookings = allBookings.filter(b => b.date === today && b.status === 'confirmed');
            const weekBookings = allBookings.filter(b => {
                const bookingDate = new Date(b.date);
                return bookingDate >= startOfWeek && b.status === 'confirmed';
            });
            const monthBookings = allBookings.filter(b => {
                const bookingDate = new Date(b.date);
                return bookingDate >= startOfMonth && b.status === 'confirmed';
            });
            
            const monthRevenue = monthBookings.reduce((sum, booking) => sum + (booking.servicePrice || 0), 0);
            
            document.getElementById('todayCount').textContent = todayBookings.length;
            document.getElementById('weekCount').textContent = weekBookings.length;
            document.getElementById('monthCount').textContent = monthBookings.length;
            document.getElementById('monthRevenue').textContent = `R$ ${monthRevenue.toFixed(2)}`;
        }

        // Navega√ß√£o do calend√°rio
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar();
        }

        // Alternar visualiza√ß√£o
        function toggleView() {
            const calendarView = document.getElementById('calendarView');
            const listView = document.getElementById('listView');
            const toggleBtn = document.getElementById('viewToggle');
            
            if (currentView === 'calendar') {
                currentView = 'list';
                calendarView.classList.add('hidden');
                listView.classList.remove('hidden');
                toggleBtn.textContent = 'üìÖ Ver Calend√°rio';
                displayBookingsList(allBookings);
            } else {
                currentView = 'calendar';
                calendarView.classList.remove('hidden');
                listView.classList.add('hidden');
                toggleBtn.textContent = 'üìã Ver Lista';
                generateCalendar();
            }
        }

        // Modal de disponibilidade
        function openAvailabilityModal() {
            document.getElementById('availabilityModal').classList.remove('hidden');
        }

        function closeAvailabilityModal() {
            document.getElementById('availabilityModal').classList.add('hidden');
        }

        // Modal de detalhes do agendamento
        function showBookingDetails(booking) {
            selectedBooking = booking;
            const modal = document.getElementById('bookingModal');
            const details = document.getElementById('bookingDetails');
            
            const statusColor = booking.status === 'confirmed' ? 'text-green-600' : 'text-red-600';
            const statusText = booking.status === 'confirmed' ? 'Confirmado' : 'Cancelado';
            
            details.innerHTML = `
                <div class="border-b pb-3 mb-3">
                    <h4 class="font-medium text-gray-800">${booking.customerName}</h4>
                    <p class="text-sm text-gray-600">üì± ${booking.customerPhone}</p>
                </div>
                <div class="space-y-2 text-sm">
                    <p><strong>Data:</strong> ${formatDate(booking.date)}</p>
                    <p><strong>Hor√°rio:</strong> ${booking.time}</p>
                    ${booking.serviceName ? `<p><strong>Servi√ßo:</strong> ${booking.serviceName}</p>` : ''}
                    ${booking.serviceDuration ? `<p><strong>Dura√ß√£o:</strong> ${booking.serviceDuration} minutos</p>` : ''}
                    ${booking.servicePrice ? `<p><strong>Pre√ßo:</strong> R$ ${booking.servicePrice.toFixed(2)}</p>` : ''}
                    <p><strong>Status:</strong> <span class="${statusColor}">${statusText}</span></p>
                    <p><strong>Criado em:</strong> ${new Date(booking.createdAt).toLocaleString('pt-BR')}</p>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.add('hidden');
            selectedBooking = null;
        }

        // ===== FUN√á√ïES AUXILIARES =====
        function formatDate(dateString) {
            const date = new Date(dateString + 'T12:00:00');
            return date.toLocaleDateString('pt-BR');
        }

        function sendWhatsAppFromModal() {
            if (!selectedBooking) return;
            
            const message = `Ol√° ${selectedBooking.customerName}! Confirming seu agendamento para ${formatDate(selectedBooking.date)} √†s ${selectedBooking.time}. At√© l√°! üòä`;
            const whatsappUrl = `https://wa.me/${selectedBooking.customerPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function exportBookings() {
            // Implementar exporta√ß√£o de dados
            alert('Funcionalidade de exporta√ß√£o em desenvolvimento!');
        }

        function cancelBookingFromModal() {
            // Implementar cancelamento de agendamento
            alert('Funcionalidade em desenvolvimento!');
        }

        // Modal controls
        function openAvailabilityModal() {
            document.getElementById('availabilityModal').classList.remove('hidden');
        }

        function closeAvailabilityModal() {
            document.getElementById('availabilityModal').classList.add('hidden');
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.add('hidden');
            selectedBooking = null;
        }

        // ===== GEST√ÉO DE DISPONIBILIDADE =====
        async function loadAvailabilityRules() {
            try {
                const response = await fetch(`/api/barbers/${barberSlug}/availability`);
                const result = await response.json();
                
                if (result.success) {
                    availabilityRules = result.data.availabilityRules;
                    updateExistingRulesList();
                }
            } catch (error) {
                console.error('Erro ao carregar regras:', error);
            }
        }

        function switchTab(tabName) {
            // Atualizar bot√µes
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(`tab-${tabName}`).classList.add('border-blue-500', 'text-blue-600');
            
            // Atualizar conte√∫do
            document.getElementById('tab-content-specific').classList.toggle('hidden', tabName !== 'specific');
            document.getElementById('tab-content-general').classList.toggle('hidden', tabName !== 'general');
        }

        async function loadDateAvailability() {
            const selectedDate = document.getElementById('selectedDate').value;
            if (!selectedDate) return;
            
            // Mostrar op√ß√µes
            document.getElementById('dateOptions').classList.remove('hidden');
            
            // Buscar regra existente
            currentDateRule = availabilityRules.find(rule => rule.date === selectedDate);
            
            if (currentDateRule) {
                // Preencher formul√°rio com dados existentes
                document.querySelector(`input[value="${currentDateRule.type}"]`).checked = true;
                updateBlockOptions();
                
                if (currentDateRule.type === 'custom_hours') {
                    document.getElementById('customOpenTime').value = currentDateRule.customOpenTime;
                    document.getElementById('customCloseTime').value = currentDateRule.customCloseTime;
                } else if (currentDateRule.type === 'blocked_hours') {
                    generateHoursList();
                    // Marcar hor√°rios bloqueados
                    currentDateRule.blockedHours.forEach(hour => {
                        const checkbox = document.querySelector(`input[value="${hour}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                document.getElementById('blockReason').value = currentDateRule.reason || '';
                document.getElementById('removeRuleBtn').classList.remove('hidden');
            } else {
                // Limpar formul√°rio
                document.querySelectorAll('input[name="blockType"]').forEach(input => input.checked = false);
                document.getElementById('blockReason').value = '';
                document.getElementById('removeRuleBtn').classList.add('hidden');
                updateBlockOptions();
            }
            
            document.getElementById('saveRuleBtn').disabled = false;
        }

        function updateBlockOptions() {
            const selectedType = document.querySelector('input[name="blockType"]:checked')?.value;
            
            // Esconder todas as se√ß√µes
            document.getElementById('customHoursSection').classList.add('hidden');
            document.getElementById('specificHoursSection').classList.add('hidden');
            
            if (selectedType === 'custom_hours') {
                document.getElementById('customHoursSection').classList.remove('hidden');
            } else if (selectedType === 'blocked_hours') {
                document.getElementById('specificHoursSection').classList.remove('hidden');
                generateHoursList();
            }
        }

        function generateHoursList() {
            const hoursList = document.getElementById('hoursList');
            hoursList.innerHTML = '';
            
            const openTime = barberData.openTime || 9;
            const closeTime = barberData.closeTime || 18;
            
            for (let hour = openTime; hour < closeTime; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-1 text-sm';
                    label.innerHTML = `
                        <input type="checkbox" value="${timeString}" class="hour-checkbox">
                        <span>${timeString}</span>
                    `;
                    
                    hoursList.appendChild(label);
                }
            }
        }

        async function saveAvailabilityRule() {
            const selectedDate = document.getElementById('selectedDate').value;
            const selectedType = document.querySelector('input[name="blockType"]:checked')?.value;
            const reason = document.getElementById('blockReason').value;
            
            if (!selectedDate || !selectedType) {
                alert('Selecione uma data e um tipo de bloqueio');
                return;
            }
            
            let ruleData = {
                date: selectedDate,
                type: selectedType,
                reason: reason
            };
            
            if (selectedType === 'custom_hours') {
                ruleData.customOpenTime = document.getElementById('customOpenTime').value;
                ruleData.customCloseTime = document.getElementById('customCloseTime').value;
            } else if (selectedType === 'blocked_hours') {
                const selectedHours = Array.from(document.querySelectorAll('.hour-checkbox:checked'))
                    .map(checkbox => checkbox.value);
                
                if (selectedHours.length === 0) {
                    alert('Selecione pelo menos um hor√°rio para bloquear');
                    return;
                }
                
                ruleData.blockedHours = selectedHours;
            }
            
            try {
                const response = await fetch(`/api/barbers/${barberSlug}/availability`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ruleData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Configura√ß√£o salva com sucesso!');
                    await loadAvailabilityRules();
                    loadDateAvailability(); // Recarregar para atualizar interface
                } else {
                    alert('‚ùå Erro: ' + result.error);
                }
            } catch (error) {
                console.error('Erro ao salvar regra:', error);
                alert('‚ùå Erro ao salvar configura√ß√£o');
            }
        }

        async function removeAvailabilityRule() {
            if (!currentDateRule) return;
            
            if (!confirm('Tem certeza que deseja remover esta configura√ß√£o?')) return;
            
            try {
                const response = await fetch(`/api/barbers/${barberSlug}/availability/${currentDateRule.id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Configura√ß√£o removida com sucesso!');
                    await loadAvailabilityRules();
                    
                    // Limpar formul√°rio
                    document.getElementById('selectedDate').value = '';
                    document.getElementById('dateOptions').classList.add('hidden');
                    currentDateRule = null;
                } else {
                    alert('‚ùå Erro: ' + result.error);
                }
            } catch (error) {
                console.error('Erro ao remover regra:', error);
                alert('‚ùå Erro ao remover configura√ß√£o');
            }
        }

        function updateExistingRulesList() {
            const container = document.getElementById('existingRules');
            container.innerHTML = '';
            
            if (availabilityRules.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma configura√ß√£o espec√≠fica ativa</p>';
                return;
            }
            
            availabilityRules.forEach(rule => {
                const ruleElement = document.createElement('div');
                ruleElement.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                
                let typeText = '';
                if (rule.type === 'blocked_day') typeText = 'üîí Dia bloqueado';
                else if (rule.type === 'custom_hours') typeText = `üïê ${rule.customOpenTime}h-${rule.customCloseTime}h`;
                else if (rule.type === 'blocked_hours') typeText = `‚è∞ ${rule.blockedHours.length} hor√°rios bloqueados`;
                
                ruleElement.innerHTML = `
                    <div>
                        <div class="font-medium text-sm">${formatDate(rule.date)}</div>
                        <div class="text-xs text-gray-600">${typeText}</div>
                        ${rule.reason ? `<div class="text-xs text-gray-500">${rule.reason}</div>` : ''}
                    </div>
                    <button 
                        onclick="editRule('${rule.id}')"
                        class="text-blue-600 hover:text-blue-800 text-sm"
                    >
                        ‚úèÔ∏è Editar
                    </button>
                `;
                
                container.appendChild(ruleElement);
            });
        }

        function editRule(ruleId) {
            const rule = availabilityRules.find(r => r.id === ruleId);
            if (!rule) return;
            
            // Definir data no seletor
            document.getElementById('selectedDate').value = rule.date;
            
            // Mudar para tab espec√≠fica
            switchTab('specific');
            
            // Carregar dados da regra
            loadDateAvailability();
        }

        async function updateSchedule() {
            const openTime = document.getElementById('newOpenTime').value;
            const closeTime = document.getElementById('newCloseTime').value;
            
            try {
                const response = await fetch(`/api/barbers/${barberSlug}/schedule`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ openTime, closeTime })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Hor√°rios atualizados com sucesso!');
                    await loadBarberData(); // Recarregar dados
                } else {
                    alert('‚ùå Erro: ' + result.error);
                }
            } catch (error) {
                console.error('Erro ao atualizar hor√°rios:', error);
                alert('‚ùå Erro ao atualizar hor√°rios');
            }
        }

        async function updateWorkingDays() {
            const workingDays = Array.from(document.querySelectorAll('.modal-day-checkbox:checked'))
                .map(checkbox => checkbox.value);
            
            if (workingDays.length === 0) {
                alert('Selecione pelo menos um dia de funcionamento');
                return;
            }
            
            try {
                const response = await fetch(`/api/barbers/${barberSlug}/working-days`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ workingDays })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Dias de funcionamento atualizados!');
                    await loadBarberData(); // Recarregar dados
                    generateCalendar(); // Regenerar calend√°rio
                } else {
                    alert('‚ùå Erro: ' + result.error);
                }
            } catch (error) {
                console.error('Erro ao atualizar dias:', error);
                alert('‚ùå Erro ao atualizar dias');
            }
        }
    </script>
</body>
</html>