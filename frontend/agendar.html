<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Hor√°rio</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Carregando...</p>
        </div>
    </div>

    <!-- Conte√∫do Principal -->
    <div id="mainContent" class="container mx-auto max-w-md p-4 hidden">
        <!-- Header -->
        <div class="text-center py-6">
            <h1 class="text-2xl font-bold text-gray-800" id="businessTitle">
                Carregando...
            </h1>
            <p class="text-gray-600 mt-1">
                Escolha o melhor hor√°rio para voc√™
            </p>
        </div>

        <!-- Erro -->
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <p>Barbeiro n√£o encontrado. Verifique o link.</p>
        </div>

        <!-- Seletor de Data -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h3 class="font-medium text-gray-700 mb-3">
                üìÖ Escolha o dia
            </h3>
            <div class="grid grid-cols-3 gap-2" id="daySelector">
                <!-- Dias ser√£o gerados via JavaScript -->
            </div>
        </div>

        <!-- Hor√°rios Dispon√≠veis -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h3 class="font-medium text-gray-700 mb-3">
                üïê Hor√°rios dispon√≠veis
            </h3>
            <div id="noSlotsMessage" class="hidden text-gray-500 text-center py-8">
                Nenhum hor√°rio dispon√≠vel para este dia.
            </div>
            <div class="grid grid-cols-3 gap-2" id="timeSlots">
                <!-- Hor√°rios ser√£o gerados via JavaScript -->
            </div>
        </div>

        <!-- Resumo e Confirma√ß√£o -->
        <div id="confirmSection" class="hidden bg-white rounded-lg shadow-md p-4">
            <h3 class="font-medium text-gray-700 mb-3">
                ‚úÖ Confirmar agendamento
            </h3>
            
            <!-- Formul√°rio de contato -->
            <div class="mb-4">
                <label class="block text-sm text-gray-600 mb-1">Seu nome</label>
                <input 
                    type="text" 
                    id="customerName" 
                    placeholder="Jo√£o Silva"
                    class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                    required
                >
            </div>
            
            <div class="mb-4">
                <label class="block text-sm text-gray-600 mb-1">Seu WhatsApp</label>
                <input 
                    type="tel" 
                    id="customerPhone" 
                    placeholder="11999999999"
                    class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                    required
                >
            </div>
            
            <div class="bg-gray-50 p-3 rounded-lg mb-4">
                <p class="text-sm text-gray-600">Data e hora selecionadas:</p>
                <p class="font-medium text-gray-800" id="selectedDateTime">
                    <!-- Ser√° preenchido via JS -->
                </p>
            </div>
            
            <button 
                onclick="confirmBooking()"
                id="confirmButton"
                class="w-full bg-green-500 text-white font-medium py-3 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2"
            >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/>
                </svg>
                Confirmar Agendamento
            </button>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let barberData = null;
        let selectedDate = null;
        let selectedTime = null;
        let existingBookings = [];

        // Pega o slug da URL
        function getBarberSlug() {
            const path = window.location.pathname;
            const slug = path.substring(1); // Remove a barra inicial
            return slug || null;
        }

        // Carrega dados do barbeiro
        async function loadBarberData() {
            const slug = getBarberSlug();
            
            if (!slug || slug.includes('.html')) {
                showError();
                return;
            }

            try {
                const response = await fetch(`/api/barbers/${slug}`);
                const result = await response.json();

                if (result.success) {
                    barberData = result.data;
                    document.getElementById('businessTitle').textContent = barberData.businessName;
                    document.title = `Agendar - ${barberData.businessName}`;
                    
                    // Gera os dias e esconde loading
                    generateDays();
                    hideLoading();
                } else {
                    showError();
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showError();
            }
        }

        // Mostra erro
        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        // Esconde loading
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        // Gera os pr√≥ximos 7 dias
        function generateDays() {
            const daySelector = document.getElementById('daySelector');
            daySelector.innerHTML = '';
            
            const today = new Date();
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                // Pula domingos (√≠ndice 0)
                if (date.getDay() === 0) continue;
                
                const dayElement = document.createElement('button');
                dayElement.className = 'p-3 border rounded-lg hover:bg-blue-50 focus:bg-blue-100 focus:border-blue-500 transition';
                dayElement.innerHTML = `
                    <div class="text-xs text-gray-500">${days[date.getDay()]}</div>
                    <div class="font-medium">${date.getDate()}</div>
                    <div class="text-xs text-gray-500">${months[date.getMonth()]}</div>
                `;
                dayElement.onclick = () => selectDate(date, dayElement);
                
                daySelector.appendChild(dayElement);
            }
            
            // Seleciona o primeiro dia dispon√≠vel
            const firstButton = daySelector.querySelector('button');
            if (firstButton) {
                firstButton.click();
            }
        }

        // Seleciona uma data
        async function selectDate(date, element) {
            selectedDate = date;
            selectedTime = null;
            
            // Remove sele√ß√£o anterior
            document.querySelectorAll('#daySelector button').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'border-blue-500');
            });
            
            // Adiciona sele√ß√£o atual
            element.classList.add('bg-blue-100', 'border-blue-500');
            
            // Esconde se√ß√£o de confirma√ß√£o
            document.getElementById('confirmSection').classList.add('hidden');
            
            // Carrega hor√°rios dispon√≠veis
            await loadAvailableSlots();
        }

       // Carrega hor√°rios dispon√≠veis
async function loadAvailableSlots() {
    const dateStr = selectedDate.toISOString().split('T')[0];
    
    try {
        // Busca agendamentos existentes
        const response = await fetch(`/api/bookings/${barberData.slug}/${dateStr}`);
        const result = await response.json();
        
        if (result.success) {
            existingBookings = result.data;
            console.log('Agendamentos existentes:', existingBookings);
        }
        
        generateTimeSlots();
    } catch (error) {
        console.error('Erro ao carregar hor√°rios:', error);
        generateTimeSlots();
    }
}

        // Gera os hor√°rios dispon√≠veis
        function generateTimeSlots() {
            const timeSlotsContainer = document.getElementById('timeSlots');
            const noSlotsMessage = document.getElementById('noSlotsMessage');
            timeSlotsContainer.innerHTML = '';
            
            const slots = [];
            const now = new Date();
            
            // Gera slots de acordo com o hor√°rio de funcionamento
            for (let hour = barberData.openTime; hour < barberData.closeTime; hour++) {
                for (let minute = 0; minute < 60; minute += barberData.serviceDuration) {
                    // Cria um objeto Date para este slot
                    const slotDate = new Date(selectedDate);
                    slotDate.setHours(hour, minute, 0, 0);
                    
                    // Pula hor√°rios que j√° passaram
                    if (slotDate <= now) continue;
                    
                    // Pula hor√°rio de almo√ßo (12h-13h)
                    if (hour === 12) continue;
                    
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;

                    // Verifica se o hor√°rio j√° est√° ocupado
                    const isBooked = existingBookings.some(booking => booking.time === timeString);

                    slots.push({
                        time: timeString,
                        available: !isBooked // Dispon√≠vel se N√ÉO estiver agendado
                    });
                }
            }
            
            if (slots.length === 0) {
                noSlotsMessage.classList.remove('hidden');
                timeSlotsContainer.classList.add('hidden');
            } else {
                noSlotsMessage.classList.add('hidden');
                timeSlotsContainer.classList.remove('hidden');
                
                slots.forEach(slot => {
                    const slotElement = document.createElement('button');
                    
                    if (slot.available) {
                        slotElement.className = 'p-2 border rounded-lg hover:bg-green-50 focus:bg-green-100 focus:border-green-500 transition text-sm';
                        slotElement.onclick = () => selectTime(slot.time, slotElement);
                    } else {
                        slotElement.className = 'p-2 border rounded-lg bg-gray-100 text-gray-400 cursor-not-allowed text-sm';
                        slotElement.disabled = true;
                    }
                    
                    slotElement.textContent = slot.time;
                    timeSlotsContainer.appendChild(slotElement);
                });
            }
        }

        // Seleciona um hor√°rio
        function selectTime(time, element) {
            selectedTime = time;
            
            // Remove sele√ß√£o anterior
            document.querySelectorAll('#timeSlots button').forEach(btn => {
                btn.classList.remove('bg-green-100', 'border-green-500');
            });
            
            // Adiciona sele√ß√£o atual
            element.classList.add('bg-green-100', 'border-green-500');
            
            // Mostra se√ß√£o de confirma√ß√£o
            showConfirmation();
        }

        // Mostra resumo para confirma√ß√£o
        function showConfirmation() {
            if (!selectedDate || !selectedTime) return;
            
            const confirmSection = document.getElementById('confirmSection');
            const selectedDateTime = document.getElementById('selectedDateTime');
            
            const dateString = selectedDate.toLocaleDateString('pt-BR', {
                weekday: 'long',
                day: 'numeric',
                month: 'long'
            });
            
            selectedDateTime.textContent = `${dateString} √†s ${selectedTime}`;
            confirmSection.classList.remove('hidden');
            
            // Scroll suave at√© a se√ß√£o
            confirmSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

       // Confirma o agendamento
async function confirmBooking() {
    const customerName = document.getElementById('customerName').value.trim();
    const customerPhone = document.getElementById('customerPhone').value.trim();
    
    if (!customerName || !customerPhone) {
        alert('Por favor, preencha seu nome e WhatsApp');
        return;
    }
    
    if (!selectedDate || !selectedTime || !barberData) return;
    
    const confirmButton = document.getElementById('confirmButton');
    confirmButton.disabled = true;
    confirmButton.textContent = 'Salvando...';
    
    try {
        // Formata a data
        const dateStr = selectedDate.toISOString().split('T')[0];
        
        // Salva no banco
        const response = await fetch('/api/bookings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                barberSlug: barberData.slug,
                date: dateStr,
                time: selectedTime,
                customerName,
                customerPhone
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Monta mensagem para WhatsApp
            const dateString = selectedDate.toLocaleDateString('pt-BR');
            const message = `Ol√° ${barberData.businessName}! 
            
Novo agendamento confirmado:
üìÖ Data: ${dateString}
üïê Hor√°rio: ${selectedTime}
üë§ Nome: ${customerName}
üì± WhatsApp: ${customerPhone}

*Agendamento salvo automaticamente no sistema!*`;
            
            const whatsappUrl = `https://wa.me/${barberData.whatsapp}?text=${encodeURIComponent(message)}`;
            
            // Abre o WhatsApp
            window.open(whatsappUrl, '_blank');
            
            // Mostra mensagem de sucesso
            alert('‚úÖ Agendamento confirmado com sucesso! Abrindo WhatsApp...');
            
            // Reseta o formul√°rio
            resetForm();
            
            // Recarrega os hor√°rios
            await loadAvailableSlots();
            
        } else {
            throw new Error(result.error || 'Erro ao salvar agendamento');
        }
        
    } catch (error) {
        console.error('Erro ao confirmar:', error);
        alert('‚ùå Erro ao confirmar agendamento. Tente novamente.');
    } finally {
        confirmButton.disabled = false;
        confirmButton.textContent = 'Confirmar Agendamento';
    }
}

        // Reseta o formul√°rio
        function resetForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('confirmSection').classList.add('hidden');
            selectedTime = null;
            
            // Remove sele√ß√£o de hor√°rio
            document.querySelectorAll('#timeSlots button').forEach(btn => {
                btn.classList.remove('bg-green-100', 'border-green-500');
            });
        }

        // Inicializa a p√°gina
        window.addEventListener('DOMContentLoaded', () => {
            loadBarberData();
        });
    </script>
</body>
</html>